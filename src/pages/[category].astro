---
import BaseLayout from '../layouts/BaseLayout.astro';
import CategoryNav from '../components/CategoryNav.astro';
import NewsCard from '../components/NewsCard.astro';

const PAGE_SIZE = 10;

const categoryLabels: Record<string, string> = {
  tech: 'Tech',
  ai: 'AI',
  economic: 'Economic',
  github: 'GitHub',
  sports: 'Sports',
};

export function getStaticPaths() {
  return ['tech', 'ai', 'economic', 'github', 'sports'].map(category => ({
    params: { category },
  }));
}

const { category } = Astro.params;
const label = categoryLabels[category!] || category;

const newsFiles = import.meta.glob('../data/news/*/*.json', { eager: true });
const articles: Array<{ title: string; slug: string; url: string; source: string; date: string; summary: string; content: string; category: string }> = [];

for (const [path, mod] of Object.entries(newsFiles)) {
  const pathCategory = path.split('/').at(-2);
  if (pathCategory !== category) continue;
  const data = (mod as any).default || mod;
  if (Array.isArray(data)) {
    articles.push(...data);
  }
}

articles.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
const initialArticles = articles.slice(0, PAGE_SIZE);
const hasMore = articles.length > PAGE_SIZE;

const collectionSchema = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": `${label} News - Oscar's News`,
  "description": `Latest ${label} news curated by AI.`,
  "url": `https://news.oscarjiang.site/${category}`,
  "mainEntity": {
    "@type": "ItemList",
    "itemListElement": initialArticles.map((article, index) => ({
      "@type": "ListItem",
      "position": index + 1,
      "name": article.title,
      "url": article.url,
    })),
  },
};

const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "https://news.oscarjiang.site",
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": label,
      "item": `https://news.oscarjiang.site/${category}`,
    },
  ],
};
---
<BaseLayout title={`${label} - Oscar's News`} structuredData={[collectionSchema, breadcrumbSchema]}>
  <h1 class="sr-only">{label} News - Oscar's News</h1>
  <CategoryNav active={category} />
  <div id="news-list">
    {initialArticles.map(article => (
      <NewsCard
        title={article.title}
        url={article.url}
        source={article.source}
        date={article.date}
        summary={article.summary}
        slug={article.slug}
        category={article.category}
      />
    ))}
  </div>
  {hasMore && (
    <div id="scroll-sentinel" style="height:1px;"></div>
    <div id="load-more-spinner" style="text-align:center;padding:2rem 0;display:none;">
      <span class="spinner"></span>
    </div>
  )}
  <script is:inline define:vars={{ category }} data-astro-rerun>
    (function() {
      var sentinel = document.getElementById('scroll-sentinel');
      if (!sentinel) return;
      var container = document.getElementById('news-list');
      var spinner = document.getElementById('load-more-spinner');
      var page = 1;
      var loading = false;
      var done = false;
      window.__loadedPages = [1];

      function relativeTime(dateStr) {
        var now = new Date();
        var then = new Date(dateStr);
        var diffMs = now.getTime() - then.getTime();
        var diffMins = Math.floor(diffMs / 60000);
        if (diffMins < 60) return diffMins + 'm ago';
        var diffHours = Math.floor(diffMins / 60);
        if (diffHours < 24) return diffHours + 'h ago';
        var diffDays = Math.floor(diffHours / 24);
        return diffDays + 'd ago';
      }

      function esc(s) {
        var d = document.createElement('div');
        d.textContent = s;
        return d.innerHTML;
      }

      function renderCard(a) {
        return '<article class="news-card" data-slug="' + esc(a.slug) + '">' +
          '<h2 class="card-heading"><a href="' + esc(a.url) + '" target="_blank" rel="noopener noreferrer" class="card-title">' + esc(a.title) + ' <span class="arrow">\u2192</span></a></h2>' +
          '<div class="card-meta"><span class="source">' + esc(a.source) + '</span><span class="separator">\u00b7</span><time datetime="' + esc(a.date) + '">' + relativeTime(a.date) + '</time></div>' +
          '<p class="card-summary">' + esc(a.summary) + '</p>' +
          '</article>';
      }

      function loadMore() {
        if (loading || done) return;
        loading = true;
        spinner.style.display = 'block';
        page++;
        var lang = document.documentElement.getAttribute('data-lang') || 'en';
        fetch('/api/articles/' + lang + '/' + category + '/' + page + '.json')
          .then(function(r) { return r.json(); })
          .then(function(data) {
            var html = '';
            for (var i = 0; i < data.items.length; i++) {
              html += renderCard(data.items[i]);
            }
            container.insertAdjacentHTML('beforeend', html);
            window.__loadedPages.push(page);

            if (!data.hasMore) {
              done = true;
              sentinel.remove();
              spinner.remove();
            } else {
              spinner.style.display = 'none';
            }
            loading = false;
          })
          .catch(function() {
            loading = false;
            spinner.style.display = 'none';
          });
      }

      var observer = new IntersectionObserver(function(entries) {
        if (entries[0].isIntersecting) loadMore();
      }, { rootMargin: '200px' });

      observer.observe(sentinel);
    })();
  </script>
</BaseLayout>
