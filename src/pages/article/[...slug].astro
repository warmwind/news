---
import BaseLayout from '../../layouts/BaseLayout.astro';

interface NewsArticle {
  title: string;
  slug: string;
  url: string;
  source: string;
  date: string;
  summary: string;
  content: string;
  category: string;
  translations?: Record<string, { title: string; summary: string }>;
}

export function getStaticPaths() {
  const newsFiles = import.meta.glob('../../data/news/*/*.json', { eager: true });
  const paths: Array<{ params: { slug: string }; props: { article: NewsArticle } }> = [];

  for (const [, mod] of Object.entries(newsFiles)) {
    const articles = ((mod as any).default || mod) as NewsArticle[];
    if (!Array.isArray(articles)) continue;
    for (const article of articles) {
      const dateStr = article.date.slice(0, 10);
      paths.push({
        params: { slug: `${article.category}/${dateStr}/${article.slug}` },
        props: { article },
      });
    }
  }

  return paths;
}

const { article } = Astro.props;

function formatDate(dateStr: string): string {
  return new Date(dateStr).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
}

const categoryLabels: Record<string, string> = {
  tech: 'Tech',
  ai: 'AI',
  economic: 'Economic',
  github: 'GitHub',
  sports: 'Sports',
};

const titleAttrs: Record<string, string> = { 'data-en': article.title };
const summaryAttrs: Record<string, string> = { 'data-en': article.summary };
if (article.translations) {
  for (const [lang, t] of Object.entries(article.translations)) {
    titleAttrs[`data-${lang}`] = t.title;
    summaryAttrs[`data-${lang}`] = t.summary;
  }
}
---
<BaseLayout title={`${article.title} - Oscar's News`}>
  <div class="article-page">
    <nav class="article-nav">
      <a href={`/${article.category}`}>&larr; {categoryLabels[article.category] || article.category}</a>
    </nav>

    <article class="article-content">
      <h1 {...titleAttrs}>{article.title}</h1>
      <div class="article-meta">
        <span class="source">{article.source}</span>
        <span class="separator">&middot;</span>
        <time datetime={article.date}>{formatDate(article.date)}</time>
      </div>

      <p class="article-summary" {...summaryAttrs}>{article.summary}</p>

      {article.content && (
        <div class="article-body">
          {article.content.split('\n\n').map(paragraph => (
            <p>{paragraph}</p>
          ))}
        </div>
      )}

      <div class="article-footer">
        <a href={article.url} target="_blank" rel="noopener noreferrer" class="original-link">
          Read original at {article.source} &rarr;
        </a>
      </div>
    </article>
  </div>
</BaseLayout>

<style>
  .article-page {
    padding: 1rem 0;
  }

  .article-nav {
    margin-bottom: 1.5rem;
  }

  .article-nav a {
    font-size: 0.875rem;
    color: var(--text-secondary);
  }

  .article-nav a:hover {
    color: var(--accent);
  }

  .article-content h1 {
    font-size: 1.75rem;
    line-height: 1.3;
    margin-bottom: 0.75rem;
    color: var(--text);
  }

  .article-meta {
    font-size: 0.8125rem;
    color: var(--text-secondary);
    margin-bottom: 1.5rem;
  }

  .separator {
    margin: 0 0.375rem;
  }

  .article-summary {
    font-size: 1.0625rem;
    line-height: 1.6;
    color: var(--text);
    margin-bottom: 1.5rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--border);
    font-style: italic;
  }

  .article-body {
    margin-bottom: 2rem;
  }

  .article-body p {
    font-size: 1rem;
    line-height: 1.7;
    color: var(--text);
    margin-bottom: 1rem;
  }

  .article-footer {
    padding-top: 1.5rem;
    border-top: 1px solid var(--border);
    margin-bottom: 2rem;
  }

  .original-link {
    font-size: 0.9375rem;
    font-weight: 500;
  }
</style>
