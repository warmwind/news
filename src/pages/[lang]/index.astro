---
import BaseLayout from '../../layouts/BaseLayout.astro';
import CategoryNav from '../../components/CategoryNav.astro';
import NewsCard from '../../components/NewsCard.astro';
import { NON_ENGLISH_LANGUAGES, OG_LOCALES, resolveTranslations, getHreflangLinks } from '../../lib/i18n';

const PAGE_SIZE = 10;

export function getStaticPaths() {
  return NON_ENGLISH_LANGUAGES.map(lang => ({
    params: { lang },
  }));
}

const { lang } = Astro.params;
const ogLocale = OG_LOCALES[lang!] || 'en_US';
const hreflangLinks = getHreflangLinks('all', 'https://news.oscarjiang.site');

const newsFiles = import.meta.glob('../../data/news/*/*.json', { eager: true });
const allNews: Array<{ title: string; slug: string; url: string; source: string; date: string; summary: string; content: string; category: string; translations?: Record<string, { title: string; summary: string }> }> = [];

for (const [, mod] of Object.entries(newsFiles)) {
  const articles = (mod as any).default || mod;
  if (Array.isArray(articles)) {
    allNews.push(...articles);
  }
}

allNews.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
const resolved = resolveTranslations(allNews, lang!);
const initialArticles = resolved.slice(0, PAGE_SIZE);
const hasMore = resolved.length > PAGE_SIZE;

const collectionSchema = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": "Oscar's News - Latest Headlines",
  "description": "AI-curated news aggregation covering tech, AI, economics, GitHub, and sports.",
  "url": `https://news.oscarjiang.site/${lang}`,
  "mainEntity": {
    "@type": "ItemList",
    "itemListElement": initialArticles.map((article, index) => ({
      "@type": "ListItem",
      "position": index + 1,
      "name": article.title,
      "url": article.url,
    })),
  },
};
---
<BaseLayout structuredData={collectionSchema} lang={lang} ogLocale={ogLocale} hreflangLinks={hreflangLinks}>
  <h1 class="sr-only">Oscar's News - Latest Headlines</h1>
  <CategoryNav active="all" lang={lang} />
  <div id="news-list">
    {initialArticles.map(article => (
      <NewsCard
        title={article.title}
        url={article.url}
        source={article.source}
        date={article.date}
        summary={article.summary}
        slug={article.slug}
        category={article.category}
      />
    ))}
  </div>
  {hasMore && (
    <div id="scroll-sentinel" style="height:1px;"></div>
    <div id="load-more-spinner" style="text-align:center;padding:2rem 0;display:none;">
      <span class="spinner"></span>
    </div>
  )}
  <script is:inline define:vars={{ lang }} data-category="all" data-astro-rerun>
    (function() {
      var sentinel = document.getElementById('scroll-sentinel');
      if (!sentinel) return;
      var container = document.getElementById('news-list');
      var spinner = document.getElementById('load-more-spinner');
      var category = 'all';
      var page = 1;
      var loading = false;
      var done = false;
      window.__loadedPages = [1];

      var cacheKey = lang + '-' + category;
      window.__newsCacheKey = cacheKey;
      var cachedHtml = sessionStorage.getItem('news-html-' + cacheKey);
      if (cachedHtml) {
        container.innerHTML = cachedHtml;
        page = parseInt(sessionStorage.getItem('news-page-' + cacheKey) || '1', 10);
        done = sessionStorage.getItem('news-done-' + cacheKey) === '1';
        window.__loadedPages = [];
        for (var p = 1; p <= page; p++) window.__loadedPages.push(p);
        if (done && sentinel) {
          sentinel.remove();
          if (spinner) spinner.remove();
        }
        var savedScroll = sessionStorage.getItem('news-scroll-' + cacheKey);
        if (savedScroll) {
          requestAnimationFrame(function() { window.scrollTo(0, parseInt(savedScroll, 10)); });
        }
        sessionStorage.removeItem('news-html-' + cacheKey);
        sessionStorage.removeItem('news-scroll-' + cacheKey);
        sessionStorage.removeItem('news-page-' + cacheKey);
        sessionStorage.removeItem('news-done-' + cacheKey);
      }
      window.__currentPage = page;
      window.__newsDone = done;

      function relativeTime(dateStr) {
        var now = new Date();
        var then = new Date(dateStr);
        var diffMs = now.getTime() - then.getTime();
        var diffMins = Math.floor(diffMs / 60000);
        if (diffMins < 60) return diffMins + 'm ago';
        var diffHours = Math.floor(diffMins / 60);
        if (diffHours < 24) return diffHours + 'h ago';
        var diffDays = Math.floor(diffHours / 24);
        return diffDays + 'd ago';
      }

      function esc(s) {
        var d = document.createElement('div');
        d.textContent = s;
        return d.innerHTML;
      }

      function renderCard(a) {
        return '<article class="news-card" data-slug="' + esc(a.slug) + '">' +
          '<h2 class="card-heading"><a href="' + esc(a.url) + '" target="_blank" rel="noopener noreferrer" class="card-title">' + esc(a.title) + ' <span class="arrow">\u2192</span></a></h2>' +
          '<div class="card-meta"><span class="source">' + esc(a.source) + '</span><span class="separator">\u00b7</span><time datetime="' + esc(a.date) + '">' + relativeTime(a.date) + '</time></div>' +
          '<p class="card-summary">' + esc(a.summary) + '</p>' +
          '</article>';
      }

      function loadMore() {
        if (loading || done) return;
        loading = true;
        spinner.style.display = 'block';
        page++;
        fetch('/api/articles/' + lang + '/' + category + '/' + page + '.json')
          .then(function(r) { return r.json(); })
          .then(function(data) {
            var html = '';
            for (var i = 0; i < data.items.length; i++) {
              html += renderCard(data.items[i]);
            }
            container.insertAdjacentHTML('beforeend', html);
            window.__loadedPages.push(page);

            if (!data.hasMore) {
              done = true;
              window.__newsDone = true;
              sentinel.remove();
              spinner.remove();
            } else {
              spinner.style.display = 'none';
            }
            window.__currentPage = page;
            loading = false;
          })
          .catch(function() {
            loading = false;
            spinner.style.display = 'none';
          });
      }

      if (!done) {
        var observer = new IntersectionObserver(function(entries) {
          if (entries[0].isIntersecting) loadMore();
        }, { rootMargin: '200px' });
        observer.observe(sentinel);
      }
    })();
  </script>
</BaseLayout>
